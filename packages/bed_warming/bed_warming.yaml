#################################################################
#                                                               #
#                     Packages/Bed Warming                      #
#                                                               #
#################################################################

#################################################################
#                                                               #
#                       Group                                   #
#                                                               #
#################################################################

group:
  bedwarm_e:
    name: Bed Warm Entities
    view: no
    entities:
      - input_number.bed_s_flag
      - input_number.bed_m_flag
      - input_number.bed_st_flag
      - input_number.bed_d_flag
      - binary_sensor.sbed
      - binary_sensor.mbed
      - binary_sensor.stbed
      - binary_sensor.dbed
      - input_boolean.bed_s
      - input_boolean.bed_m
      - input_boolean.bed_st
      - input_boolean.bed_d
      - timer.bed_s_timer
      - timer.bed_m_timer
      - timer.bed_st_timer
      - timer.bed_d_timer

  bedwarm_s:
    name: Bed Warm Scripts
    view: no
    entities:
      - script.beds_on_prewarm
      - script.bed_s_on
      - script.bed_m_on
      - script.bed_st_on
      - script.bed_d_on
      - script.beds_on_timer
      - script.bed_s_on_t
      - script.bed_m_on_t
      - script.bed_st_on_t
      - script.bed_d_on_t
      - script.beds_off
      - script.bed_s_off
      - script.bed_m_off
      - script.bed_st_off
      - script.bed_d_off

  bedwarm_a:
    name: Bed Warm Automations
    view: no
    entities:
      - automation.bed_auto_on_evening
      - automation.bed_timer_s
      - automation.bed_timer_m
      - automation.bed_timer_st
      - automation.bed_timer_d
      - automation.bed_s_off
      - automation.bed_m_off
      - automation.bed_st_off
      - automation.bed_d_off
      - automation.bed_s_auto_off
      - automation.bed_m_auto_off
      - automation.bed_st_auto_off
      - automation.bed_d_auto_off
  

#################################################################
#                                                               #
#                       Input Number                            #
#                                                               #
#################################################################

input_number:

####################################################
#                                                  #
#                Input Numbers - Warm Beds         #
#                                                  #
####################################################

  bed_s_flag:
    min: 5
    max: 15
    name: "Warm Simon's bed"
    #initial: 12
    unit_of_measurement: 'C'
    icon: mdi:hotel

  bed_m_flag:
    min: 5
    max: 15
    name: "Warm Megan's bed"
    #initial: 12
    unit_of_measurement: 'C'
    icon: mdi:hotel

  bed_st_flag:
    min: 5
    max: 15
    name: "Warm Staci's bed"
    #initial: 12
    unit_of_measurement: 'C'
    icon: mdi:hotel

  bed_d_flag:
    min: 5
    max: 15
    name: "Warm Delia's bed"
    #initial: 12
    unit_of_measurement: 'C'
    icon: mdi:hotel
    
#################################################################
#                                                               #
#                  Binary Sensors                               #
#                                                               #
#################################################################

binary_sensor:

####################################################
#                                                  #
#        Binary Sensor - Warm Beds                #
#                                                  #
####################################################

  - platform: template
    sensors:
      sbed:
        friendly_name: Warm Simon's bed tonight
        value_template: "{{ states('sensor.dark_sky_overnight_low_temperature_0')|float < states('input_number.bed_s_flag')|float }}"
        icon_template: mdi:radiator
      mbed:
        friendly_name: Warm Megan's bed tonight
        value_template: "{{ states('sensor.dark_sky_overnight_low_temperature_0')|float < states('input_number.bed_m_flag')|float }}"
        icon_template: mdi:radiator
      stbed:
        friendly_name: Warm Staci's bed tonight
        value_template: "{{ states('sensor.dark_sky_overnight_low_temperature_0')|float < states('input_number.bed_st_flag')|float }}"
        icon_template: mdi:radiator
      dbed:
        friendly_name: Warm Delia's bed tonight
        value_template: "{{ states('sensor.dark_sky_overnight_low_temperature_0')|float < states('input_number.bed_d_flag')|float }}"
        icon_template: mdi:radiator
 
#################################################################
#                                                               #
#                            Input Boolean                      #
#                                                               #
#################################################################

input_boolean:

####################################################
#                                                  #
#           Input Boolean - Warm Beds on timer     #
#                                                  #
####################################################

  bed_s:
    name: Simon Bed warm on timer
    initial: off
    icon: mdi:hotel

  bed_m:
    name: Megan Bed warm on timer
    initial: off
    icon: mdi:hotel

  bed_st:
    name: Staci Bed warm on timer
    initial: off
    icon: mdi:hotel

  bed_d:
    name: Delia Bed warm on timer
    initial: off
    icon: mdi:hotel        

#################################################################
#                                                               #
#                            Timers                             #
#                                                               #
#################################################################

timer:

####################################################
#                                                  #
#                Timer  - Warm Beds                #
#                                                  #
####################################################

  bed_s_timer:
    duration: '01:00:00'

  bed_m_timer:
    duration: '01:00:00'

  bed_st_timer:
    duration: '01:00:00'

  bed_d_timer:
    duration: '01:00:00'

#################################################################
#                                                               #
#                            Script                             #
#                                                               #
#################################################################

script:

####################################################
#                                                  #
#                script  - turn on beds prewarm    #
#                                                  #
####################################################

  beds_on_prewarm:
    sequence:
      service: script.turn_on
      entity_id:
        - script.bed_s_on
        - script.bed_m_on
        - script.bed_st_on
        - script.bed_d_on

  bed_s_on:
    sequence:
      - condition: state
        entity_id: binary_sensor.sbed
        state: 'on'
      - service: homeassistant.turn_on
        entity_id: switch.simon_blanket

  bed_m_on:
    sequence:
      - condition: state
        entity_id: binary_sensor.mbed
        state: 'on'
      - service: homeassistant.turn_on
        entity_id: switch.megan_blanket

  bed_st_on:
    sequence:
      - condition: state
        entity_id: binary_sensor.stbed
        state: 'on'
      - service: homeassistant.turn_on
        entity_id: switch.staci_blanket

  bed_d_on:
    sequence:
      - condition: state
        entity_id: binary_sensor.dbed
        state: 'on'
      - service: homeassistant.turn_on
        entity_id: switch.delia_blanket

####################################################
#                                                  #
#                script  - turn on beds timer      #
#                                                  #
####################################################

  beds_on_timer:
    sequence:
      service: script.turn_on
      entity_id:
        - script.bed_s_on_t
        - script.bed_m_on_t
        - script.bed_st_on_t
        - script.bed_d_on_t

  bed_s_on_t:
    sequence:
      - service: homeassistant.turn_on
        entity_id: switch.simon_blanket
      - service: timer.start
        entity_id: timer.bed_s_timer
      

  bed_m_on_t:
    sequence:
      - service: homeassistant.turn_on
        entity_id: switch.megan_blanket
      - service: timer.start
        entity_id: timer.bed_m_timer
      

  bed_st_on_t:
    sequence:
      - service: homeassistant.turn_on
        entity_id: switch.staci_blanket
      - service: timer.start
        entity_id: timer.bed_st_timer
      

  bed_d_on_t:
    sequence:
      - service: homeassistant.turn_on
        entity_id: switch.delia_blanket
      - service: timer.start
        entity_id: timer.bed_d_timer
      

####################################################
#                                                  #
#                script  - turn off beds           #
#                                                  #
####################################################

  beds_off:
    sequence:
      service: script.turn_on
      entity_id:
        - script.bed_s_off
        - script.bed_m_off
        - script.bed_st_off
        - script.bed_d_off

  bed_s_off:
    sequence:
      - service: homeassistant.turn_off
        entity_id: 
          - switch.simon_blanket
          - input_boolean.bed_s
      - service: timer.cancel
        entity_id: timer.bed_s_timer

  bed_m_off:
    sequence:
      - service: homeassistant.turn_off
        entity_id: 
          - switch.megan_blanket
          - input_boolean.bed_m
      - service: timer.cancel
        entity_id: timer.bed_m_timer


  bed_st_off:
    sequence:
      - service: homeassistant.turn_off
        entity_id: 
          - switch.staci_blanket
          - input_boolean.bed_st
      - service: timer.cancel
        entity_id: timer.bed_st_timer


  bed_d_off:
    sequence:
      - service: homeassistant.turn_off
        entity_id: 
          - switch.delia_blanket
          - input_boolean.bed_d
      - service: timer.cancel
        entity_id: timer.bed_d_timer


#################################################################
#                                                               #
#                            Automation                         #
#                                                               #
#################################################################

automation:

####################################################
#                                                  #
#                automation - turn on beds         #
# evening mode (if overnight temp cold)
#                                                  #
####################################################

  - alias: bed_auto_on_evening
    trigger:
      - platform: state
        entity_id: binary_sensor.mode_evening
        to: 'on'
    action:
      - service: script.turn_on
        entity_id: script.beds_on_prewarm

####################################################
#                                                  #
#                automation - turn on beds         #
# flagged on - turn on with timer
#                                                  #
####################################################

  - alias: bed_timer_s
    trigger:
      - platform: state
        entity_id: input_boolean.bed_s
        to: 'on'
    action:
      - service: script.turn_on
        entity_id: script.bed_s_on_t

  - alias: bed_timer_m
    trigger:
      - platform: state
        entity_id: input_boolean.bed_m
        to: 'on'
    action:
      - service: script.turn_on
        entity_id: script.bed_m_on_t

  - alias: bed_timer_st
    trigger:
      - platform: state
        entity_id: input_boolean.bed_st
        to: 'on'
    action:
      - service: script.turn_on
        entity_id: script.bed_st_on_t

  - alias: bed_timer_d
    trigger:
      - platform: state
        entity_id: input_boolean.bed_d
        to: 'on'
    action:
      - service: script.turn_on
        entity_id: script.bed_d_on_t

####################################################
#                                                  #
#                automation - turn off beds switch #
# flagged off - turn off and timer
#                                                  #
####################################################

  - alias: bed_s_off
    trigger:
      - platform: state
        entity_id: input_boolean.bed_s
        to: 'off'
    action:
      - service: script.turn_on
        entity_id: script.bed_s_off

  - alias: bed_m_off
    trigger:
      - platform: state
        entity_id: input_boolean.bed_m
        to: 'off'
    action:
      - service: script.turn_on
        entity_id: script.bed_m_off

  - alias: bed_st_off
    trigger:
      - platform: state
        entity_id: input_boolean.bed_st
        to: 'off'
    action:
      - service: script.turn_on
        entity_id: script.bed_st_off

  - alias: bed_d_off
    trigger:
      - platform: state
        entity_id: input_boolean.bed_d
        to: 'off'
    action:
      - service: script.turn_on
        entity_id: script.bed_d_off


####################################################
#                                                  #
#                automation  - turn off beds       #
# timer done, night, day or morning modes
#                                                  #
####################################################

  - alias: bed_s_auto_off
    trigger:
      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.bed_s_timer
      - platform: state
        entity_id: binary_sensor.mode_night
        to: 'on'
      - platform: state
        entity_id: binary_sensor.mode_day
        to: 'on'
      - platform: state
        entity_id: binary_sensor.mode_morning
        to: 'on'
    action:
      - service: script.turn_on
        entity_id: script.bed_s_off

  - alias: bed_m_auto_off
    trigger:
      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.bed_m_timer
      - platform: state
        entity_id: binary_sensor.mode_night
        to: 'on'
      - platform: state
        entity_id: binary_sensor.mode_day
        to: 'on'
      - platform: state
        entity_id: binary_sensor.mode_morning
        to: 'on'
    action:
      - service: script.turn_on
        entity_id: script.bed_m_off

  - alias: bed_st_auto_off
    trigger:
      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.bed_st_timer
      - platform: state
        entity_id: binary_sensor.mode_night
        to: 'on'
      - platform: state
        entity_id: binary_sensor.mode_day
        to: 'on'
      - platform: state
        entity_id: binary_sensor.mode_morning
        to: 'on'
    action:
      - service: script.turn_on
        entity_id: script.bed_st_off

  - alias: bed_d_auto_off
    trigger:
      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.bed_d_timer
      - platform: state
        entity_id: binary_sensor.mode_night
        to: 'on'
      - platform: state
        entity_id: binary_sensor.mode_day
        to: 'on'
      - platform: state
        entity_id: binary_sensor.mode_morning
        to: 'on'
    action:
      - service: script.turn_on
        entity_id: script.bed_d_off